<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockWar Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            position: relative;
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h3 {
            margin-bottom: 10px;
        }

        .floating-right {
            position: absolute;
            top: -5px;
            right: 0;
            width: 250px;
            background: #ff6b6b;
            color: #fff;
            border-radius: 0 20px 0 0;
        }

        .floating-right:hover {
            background: #000;
            transform: none;
            box-shadow: none;
        }
        
        .screens {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }
        
        input, button, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px 0 5px 0;
        }
        
        input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .rooms-list {
            display: grid;
            gap: 15px;
            margin: 25px 0;
        }
        
        .room-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        
        .room-info {
            margin-bottom: 15px;
        }
        
        .room-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .room-details {
            color: #666;
            font-size: 0.95em;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .room-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .join-button-container {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .lobby-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .lobby-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .lobby-header h2 {
            color: #333;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .room-info-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .player-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 3px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .player-card.current-player {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e6eeff);
        }
        
        .player-card.host {
            border-color: #ffd700;
            background: linear-gradient(135deg, #fff9e6, #fff0cc);
        }
        
        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .player-status {
            color: #666;
            font-size: 0.9em;
        }
        
        /* Game Screen Layout - 4 boards side by side */
        .game-boards-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .player-game-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #e9ecef;
            display: flex;
            flex-direction: column;
            height: 650px;
        }
        
        .player-game-area.current-player {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9fa, #f0f4ff);
        }
        
        .player-game-area.game-over {
            border-color: #ff6b6b;
            opacity: 0.8;
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .player-game-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .player-game-name {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
        }
        
        .player-score {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .game-content {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            flex: 1;
        }
        
        .game-board-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .game-board {
            display: grid;
            grid-template-rows: repeat(20, 20px);
            grid-template-columns: repeat(10, 20px);
            gap: 1px;
            background: #2c3e50;
            border: 3px solid #2c3e50;
            border-radius: 8px;
        }
        
        .cell {
            width: 20px;
            height: 20px;
            background: #1a252f;
            border-radius: 2px;
        }
        
        .cell.filled {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .next-piece-container {
            text-align: center;
        }
        
        .next-piece-board {
            display: inline-grid;
            grid-template-rows: repeat(4, 15px);
            grid-template-columns: repeat(4, 15px);
            gap: 1px;
            background: #2c3e50;
            margin-top: 5px;
        }
        
        /* Powerups stacked vertically beside game board */
        .powerup-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .powerup-inventory {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #e9ecef;
            height: 100%;
            overflow: auto;
        }
        
        .powerup-inventory h4 {
            color: #333;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.1em;
        }
        
        .powerup-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .powerup-item {
            background: white;
            padding: 5px;
            border-radius: 8px;
            display: block;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .powerup-item:hover {
            border-color: #667eea;
            transform: translateX(3px);
        }
        
        .powerup-icon {
            font-size: 1.8em;
            width: 40px;
            margin: auto;
        }
        
        .powerup-info {
            flex: 1;
        }
        
        .powerup-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        
        .powerup-desc {
            font-size: 0.75em;
            color: #666;
        }
        
        .powerup-controls {
            background: linear-gradient(135deg, #f0f4ff, #e6eeff);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
        }
        
        .powerup-controls h4 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1em;
        }
        
        .powerup-keys {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .powerup-key {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        
        .powerup-key:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .controls {
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }
        
        .controls h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .game-over {
            background: #ff6b6b;
            color: white;
            padding: 5px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin: 0;
        }
        
        .no-powerups {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .powerup-help {
            background: linear-gradient(135deg, #fff9e6, #fff0cc);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ffd700;
        }
        
        .powerup-help h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
        }
        
        .powerup-help p {
            margin: 5px 0;
            font-size: 0.85em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 BlockWar Battle</h1>
        
        <div class="screens">
            <!-- Main Menu Screen -->
            <div id="mainMenu" class="screen active">
                <div class="form-group">
                    <button onclick="showScreen('createRoomScreen')">Create Battle Room</button>
                </div>
                <div class="form-group">
                    <button onclick="showScreen('joinRoomScreen')">Join Battle Room</button>
                </div>
            </div>
            
            <!-- Create Room Screen -->
            <div id="createRoomScreen" class="screen">
                <h2>Create Battle Room</h2>
                <div class="form-group">
                    <label for="createPlayerName">Your Warrior Name:</label>
                    <input type="text" id="createPlayerName" placeholder="Enter your warrior name" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="roomName">Room Name:</label>
                    <input type="text" id="roomName" placeholder="Enter an epic room name" maxlength="30">
                </div>
                <button onclick="createRoom()">Create Battle Room</button>
                <button onclick="showScreen('mainMenu')">Back to Main Menu</button>
            </div>
            
            <!-- Join Room Screen -->
            <div id="joinRoomScreen" class="screen">
                <h2>Join Battle Room</h2>
                <div class="form-group">
                    <label for="joinPlayerName">Your Warrior Name:</label>
                    <input type="text" id="joinPlayerName" placeholder="Enter your warrior name" maxlength="20">
                </div>
                <h3>Available Battle Rooms:</h3>
                <div id="roomsList" class="rooms-list"></div>
                <button onclick="showScreen('mainMenu')">Back to Main Menu</button>
            </div>
            
            <!-- Lobby Screen -->
            <div id="lobbyScreen" class="screen">
                <div class="lobby-container">
                    <div class="lobby-header">
                        <h2>Battle Lobby</h2>
                        <div class="room-info-badge" id="lobbyRoomInfo">Room: Loading...</div>
                    </div>
                    
                    <div class="players-grid" id="lobbyPlayers"></div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="startGameBtn" onclick="startGame()" style="padding: 15px 30px; font-size: 1.2em;">Start Epic Battle!</button>
                        <button onclick="leaveRoom()" style="margin-top: 15px; background: #6c757d;">Leave Lobby</button>
                    </div>
                </div>
            </div>
            
            <!-- Game Screen -->
            <div id="gameScreen" class="screen">
                <button class="floating-right" onclick="leaveGame()">Leave Game</button>
                <div id="gameInfo" style="margin-bottom: 20px;"></div>
                
                <div class="game-boards-container" id="gameBoardsContainer">
                    <!-- 4 game boards will be populated here -->
                </div>
                
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io();
        let currentRoomId = null;
        let currentPlayerId = null;
        let players = [];
        let currentRoomName = '';
        
        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // Room creation
        function createRoom() {
            const playerName = document.getElementById('createPlayerName').value.trim();
            const roomName = document.getElementById('roomName').value.trim();
            
            if (!playerName) {
                alert('Please enter your warrior name');
                return;
            }
            if (!roomName) {
                alert('Please enter a room name');
                return;
            }
            
            socket.emit('createRoom', { playerName, roomName });
        }
        
        // Room joining
        function joinRoom(roomId) {
            const playerName = document.getElementById('joinPlayerName').value.trim();
            if (!playerName) {
                alert('Please enter your warrior name');
                return;
            }
            socket.emit('joinRoom', { roomId, playerName });
        }
        
        // Game start
        function startGame() {
            socket.emit('startGame', currentRoomId);
        }
        
        // Room leaving
        function leaveRoom() {
            if (currentRoomId) {
                socket.emit('leaveRoom', currentRoomId);
            }
            currentRoomId = null;
            currentRoomName = '';
            players = [];
            showScreen('mainMenu');
        }
        
        function leaveGame() {
            leaveRoom();
        }
        
        // Powerup usage with keyboard keys (1-4 only)
        function usePowerupOnPlayer(playerNumber) {
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            if (!currentPlayer || currentPlayer.powerups.length === 0) {
                showQuickNotification('No powerups available!');
                return;
            }
            
            const targetPlayer = players[playerNumber - 1];
            if (!targetPlayer) {
                showQuickNotification(`Player ${playerNumber} not found!`);
                return;
            }
            
            socket.emit('usePowerup', {
                roomId: currentRoomId,
                targetPlayerId: targetPlayer.id
            });
            
            // const powerupName = currentPlayer.powerups[0].name;
            // showQuickNotification(`Used ${powerupName} on ${targetPlayer.name}!`);
        }
        
        // Quick notification system
        function showQuickNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 20px;
                border-radius: 12px;
                z-index: 1000;
                max-width: 350px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 1500);
        }
        
        // Play victory sound
        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 880;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } catch (e) {
                console.log('Audio not supported:', e);
            }
        }
        
        // Socket event handlers
        socket.on('roomCreated', (roomId) => {
            currentRoomId = roomId;
            showLobby();
        });
        
        socket.on('roomJoined', (roomId) => {
            currentRoomId = roomId;
            showLobby();
        });
        
        socket.on('joinError', (message) => {
            alert(message);
        });
        
        socket.on('startError', (message) => {
            alert(message);
        });
        
        socket.on('gameStarted', () => {
            console.log('Game started by host!');
            showScreen('gameScreen');
        });
        
        socket.on('gameEnded', (data) => {
            const winner = data.winner;
            if (winner) {
                const winnerDiv = document.createElement('div');
                winnerDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #000000, #434343);
                    color: gold;
                    padding: 50px;
                    border-radius: 25px;
                    text-align: center;
                    z-index: 1000;
                    font-size: 2.5em;
                    border: 5px solid gold;
                    box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
                `;
                winnerDiv.innerHTML = `
                    <h2>🏆 VICTORY! 🏆</h2>
                    <p style="margin: 20px 0;">Winner: ${winner.name}</p>
                    <p style="margin: 20px 0;">Final Score: ${winner.score}</p>
                    <button onclick="this.parentElement.remove()" style="margin-top: 30px; padding: 15px 30px; font-size: 0.6em; background: gold; color: black; border: none; border-radius: 10px; cursor: pointer;">Continue</button>
                `;
                document.body.appendChild(winnerDiv);
                
                playVictorySound();
            }
        });
        
        socket.on('powerupAcquired', (data) => {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 20px;
                border-radius: 12px;
                z-index: 1000;
                max-width: 350px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            `;
            notification.innerHTML = `
                <strong>${data.playerName}</strong> acquired:<br>
                <div style="font-size: 2em; margin: 10px 0;">${data.powerup.icon}</div>
                <strong>${data.powerup.name}</strong>!<br>
                <small>${data.powerup.description}</small>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 3000);
        });
        
        socket.on('powerupUsed', (data) => {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
                padding: 20px;
                border-radius: 12px;
                z-index: 1000;
                max-width: 350px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            `;
            notification.innerHTML = `
                <strong>${data.playerName}</strong> used<br>
                <div style="font-size: 2em; margin: 10px 0;">${data.powerup.icon}</div>
                <strong>${data.powerup.name}</strong><br>
                on <strong>${data.targetPlayerName}</strong>!
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.parentElement.removeChild(notification);
                }
            }, 3000);
        });
        
        socket.on('lobbyUpdate', (lobbyData) => {
            players = lobbyData.players;
            currentPlayerId = socket.id;
            currentRoomName = lobbyData.roomName;
            updateLobbyDisplay(lobbyData);
        });
        
        socket.on('roomListUpdate', (roomList) => {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';
            
            roomList.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                roomElement.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${room.name}</div>
                        <div class="room-details">
                            <div class="room-detail">👑 Host: ${room.host}</div>
                            <div class="room-detail">👥 Players: ${room.playerCount}/${room.maxPlayers}</div>
                            <div class="room-detail">${room.gameState === 'waiting' ? '🟢 Waiting' : '🔴 In Game'}</div>
                        </div>
                    </div>
                    <div class="join-button-container">
                        <button onclick="joinRoom('${room.id}')" 
                            ${room.playerCount >= room.maxPlayers || room.gameState === 'playing' ? 'disabled' : ''}
                            style="min-width: 120px;">
                            ${room.gameState === 'playing' ? 'In Battle' : 
                              room.playerCount >= room.maxPlayers ? 'Full' : 'Join Battle'}
                        </button>
                    </div>
                `;
                roomsList.appendChild(roomElement);
            });
        });
        
        socket.on('gameUpdate', (gameData) => {
            players = gameData.players;
            currentPlayerId = socket.id;
            updateGameDisplay(gameData);
        });
        
        function showLobby() {
            showScreen('lobbyScreen');
        }
        
        function updateLobbyDisplay(lobbyData) {
            const lobbyPlayers = document.getElementById('lobbyPlayers');
            const lobbyRoomInfo = document.getElementById('lobbyRoomInfo');
            const startGameBtn = document.getElementById('startGameBtn');
            
            // Update room info with player count
            lobbyRoomInfo.textContent = `${currentRoomName} - ${players.length}/4 Players`;
            lobbyPlayers.innerHTML = '';
            
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            const isHost = currentPlayer ? currentPlayer.isHost : false;
            
            if (players.length === 0) {
                lobbyPlayers.innerHTML = '<div style="text-align: center; grid-column: 1 / -1; color: #666; font-size: 1.2em;">Waiting for warriors to join the battle...</div>';
            } else {
                players.forEach(player => {
                    const isCurrent = player.id === currentPlayerId;
                    const playerCard = document.createElement('div');
                    playerCard.className = `player-card ${isCurrent ? 'current-player' : ''} ${player.isHost ? 'host' : ''}`;
                    
                    const avatarEmoji = player.isHost ? '👑' : '⚔️';
                    
                    playerCard.innerHTML = `
                        <div class="player-avatar">${avatarEmoji}</div>
                        <div class="player-name">${player.name}</div>
                        <div class="player-status">
                            ${isCurrent ? '(You)' : ''}
                            ${player.isHost ? ' • Room Host' : ''}
                        </div>
                    `;
                    lobbyPlayers.appendChild(playerCard);
                });
            }
            
            startGameBtn.style.display = (isHost && players.length >= 2) ? 'block' : 'none';
            startGameBtn.disabled = players.length < 2;
            startGameBtn.textContent = players.length < 2 ? `Need ${2 - players.length} more warriors...` : 'Start Epic Battle!';
        }
        
        const COLORS = {
            cyan: '#00bcd4', yellow: '#ffeb3b', purple: '#9c27b0', 
            green: '#4caf50', red: '#f44336', blue: '#2196f3', 
            orange: '#ff9800', gray: '#78909c'
        };
        
        const TETROMINOS = {
            I: { shape: [[0,0,0,0], [1,1,1,1], [0,0,0,0], [0,0,0,0]], color: 'cyan' },
            O: { shape: [[1,1], [1,1]], color: 'yellow' },
            T: { shape: [[0,1,0], [1,1,1], [0,0,0]], color: 'purple' },
            S: { shape: [[0,1,1], [1,1,0], [0,0,0]], color: 'green' },
            Z: { shape: [[1,1,0], [0,1,1], [0,0,0]], color: 'red' },
            J: { shape: [[1,0,0], [1,1,1], [0,0,0]], color: 'blue' },
            L: { shape: [[0,0,1], [1,1,1], [0,0,0]], color: 'orange' }
        };
        
        function getRotatedShape(pieceType, rotation) {
            let shape = TETROMINOS[pieceType].shape;
            for (let i = 0; i < rotation; i++) {
                shape = shape[0].map((_, index) => shape.map(row => row[index]).reverse());
            }
            return shape;
        }
        
        function updateGameDisplay(gameData) {
            const gameBoardsContainer = document.getElementById('gameBoardsContainer');
            const gameInfo = document.getElementById('gameInfo');
            
            gameBoardsContainer.innerHTML = '';
            
            if (gameData.gameState === 'finished') {
                gameInfo.innerHTML = `
                    <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <h3>🏁 Battle Finished - ${currentRoomName}</h3>
                        <p>Game Over! Return to the lobby it you want to join a new battle.</p>
                    </div>
                `;
            } else {
                const activePlayers = players.filter(p => !p.isGameOver).length;
                gameInfo.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                        <h3>⚔️ ${currentRoomName} - Battle in Progress</h3>
                        <p>Movement: ← → Arrow Keys | Rotate: ↑ Up Arrow | Soft Drop: ↓ Down Arrow | Hard Drop: Spacebar | Powerups: Press 1-4 to use on Players 1-4</p>
                    </div>
                `;
            }
            
            // Create player slots
            for (let i = 0; i < players.length; i++) {
                const player = players[i];
                const playerArea = document.createElement('div');
                playerArea.className = `player-game-area ${player && player.id === currentPlayerId ? 'current-player' : ''}`;
                
                if (player) {
                    // Player exists - show their game
                    playerArea.innerHTML = `
                        <div class="player-header">
                            <div class="player-game-info">
                                <div class="player-badge">P${i + 1}</div>
                                <div class="player-game-name">${player.name}</div>
                                ${player.isHost ? '👑' : ''}
                                ${player.id === currentPlayerId ? '⭐' : ''}
                                ${player.isGameOver ? '<div class="game-over">💀 ELIMINATED</div>' : ''}
                            </div>
                            <div class="player-score">${player.score}</div>
                        </div>

                        <div class="game-content">
                            <div class="game-board-container">
                                <div class="game-board" id="board-${player.id}"></div>
                                <div class="next-piece-container">
                                    <div>Next Piece:</div>
                                    <div class="next-piece-board" id="next-${player.id}"></div>
                                </div>
                            </div>
                            
                            <div class="powerup-sidebar">
                                <div class="powerup-inventory">
                                    <h4>⚡ Powerups</h4>
                                    <div class="powerup-list" id="powerups-${player.id}">
                                        ${player.powerups.length > 0 ? 
                                            player.powerups.map(powerup => `
                                                <div class="powerup-item" title="${powerup.description}">
                                                    <div class="powerup-icon">${powerup.icon}</div>
                                                    <div class="powerup-info">
                                                        <div class="powerup-name">${powerup.name}</div>
                                                    </div>
                                                </div>
                                            `).join('') : 
                                            '<div class="no-powerups">No powerups</div>'
                                        }
                                    </div>
                                </div>
                               
                            </div>
                        </div>
                    `;
                } else {
                    // Empty player slot
                    playerArea.innerHTML = `
                        <div class="player-header">
                            <div class="player-game-info">
                                <div class="player-badge">P${i + 1}</div>
                                <div class="player-game-name">Waiting for player...</div>
                            </div>
                            <div class="player-score">-</div>
                        </div>
                        
                        <div style="flex: 1; display: flex; align-items: center; justify-content: center; color: #999; font-size: 1.2em;">
                            Empty Slot
                        </div>
                    `;
                }
                
                gameBoardsContainer.appendChild(playerArea);
                
                if (player) {
                    renderBoard(player.board, `board-${player.id}`);
                    renderNextPiece(player.nextPiece, `next-${player.id}`);
                    
                    if (!player.isGameOver && player.currentPiece) {
                        renderCurrentPiece(player, `board-${player.id}`);
                    }
                }
            }
        }
        
        function renderBoard(board, boardId) {
            const boardElement = document.getElementById(boardId);
            if (!boardElement) return;
            
            boardElement.innerHTML = '';
            
            for (let y = 0; y < board.length; y++) {
                for (let x = 0; x < board[y].length; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (board[y][x] !== 0) {
                        cell.classList.add('filled');
                        cell.style.background = COLORS[board[y][x]] || board[y][x];
                    }
                    boardElement.appendChild(cell);
                }
            }
        }
        
        function renderNextPiece(pieceType, nextId) {
            const nextElement = document.getElementById(nextId);
            if (!nextElement || !pieceType) return;
            
            nextElement.innerHTML = '';
            const piece = TETROMINOS[pieceType];
            
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (piece.shape[y] && piece.shape[y][x]) {
                        cell.classList.add('filled');
                        cell.style.background = COLORS[piece.color];
                    }
                    nextElement.appendChild(cell);
                }
            }
        }
        
        function renderCurrentPiece(player, boardId) {
            const boardElement = document.getElementById(boardId);
            if (!boardElement) return;
            
            const shape = getRotatedShape(player.currentPiece, player.rotation);
            const color = TETROMINOS[player.currentPiece].color;
            const cells = boardElement.children;
            
            for (let y = 0; y < shape.length; y++) {
                for (let x = 0; x < shape[y].length; x++) {
                    if (shape[y][x] !== 0) {
                        const boardY = player.position.y + y;
                        const boardX = player.position.x + x;
                        
                        if (boardY >= 0 && boardY < 20 && boardX >= 0 && boardX < 10) {
                            const index = boardY * 10 + boardX;
                            if (index < cells.length) {
                                cells[index].classList.add('filled');
                                cells[index].style.background = color;
                            }
                        }
                    }
                }
            }
        }
        
        // Keyboard controls for game AND powerups
        document.addEventListener('keydown', (event) => {
            if (!currentRoomId || !players.find(p => p.id === currentPlayerId && !p.isGameOver)) return;
            
            const currentPlayer = players.find(p => p.id === currentPlayerId);
            const hasPowerups = currentPlayer && currentPlayer.powerups.length > 0;
            
            switch (event.key) {
                // Game controls
                case 'ArrowLeft': socket.emit('keyPress', { roomId: currentRoomId, key: 'left' }); break;
                case 'ArrowRight': socket.emit('keyPress', { roomId: currentRoomId, key: 'right' }); break;
                case 'ArrowDown': socket.emit('keyPress', { roomId: currentRoomId, key: 'down' }); break;
                case 'ArrowUp': socket.emit('keyPress', { roomId: currentRoomId, key: 'up' }); break;
                case ' ': socket.emit('keyPress', { roomId: currentRoomId, key: 'space' }); break;
                
                // Powerup controls (only if player has powerups) - Keys 1-4 only
                case '1': if (hasPowerups) usePowerupOnPlayer(1); break;
                case '2': if (hasPowerups) usePowerupOnPlayer(2); break;
                case '3': if (hasPowerups) usePowerupOnPlayer(3); break;
                case '4': if (hasPowerups) usePowerupOnPlayer(4); break;
            }
        });
    </script>
</body>
</html>